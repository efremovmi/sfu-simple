<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple SFU Client</title>
</head>
<body>

<link rel="icon" href="data:,">

<h3 id="status">Connecting...</h3>
<button onclick="start()">Start</button>

<video id="local" autoplay muted playsinline style="width:300px;"></video>
<video id="remote" autoplay playsinline style="width:300px;"></video>

<script>
    let isInitiator = false;
    let localStream = null;

    const statusEl = document.getElementById("status");
    const local = document.getElementById("local");
    const remote = document.getElementById("remote");

    const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    const ws = new WebSocket("wss://your_ip:8080/ws");

    // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    async function getMediaStream() {
        if (!localStream) {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            local.srcObject = localStream;

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –≤ RTCPeerConnection
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
        }
        return localStream;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    pc.onicecandidate = e => {
        if (e.candidate) ws.send(JSON.stringify(e.candidate));
    };

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏
    pc.ontrack = e => {
        if (!remote.srcObject) {
            remote.srcObject = new MediaStream();
        }
        e.streams[0].getTracks().forEach(track => {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –≤ MediaStream
            if (!remote.srcObject.getTracks().some(t => t.id === track.id)) {
                remote.srcObject.addTrack(track);
            }
        });
        // statusEl.innerText = "Connected üéâ";
    };

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ ICE –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    pc.oniceconnectionstatechange = () => {
        statusEl.innerText = "ICE: " + pc.iceConnectionState;
    };
    pc.onconnectionstatechange = () => {
        if ( pc.connectionState === "connected"){
            statusEl.innerText = "Connected üéâ";
        } else{
            statusEl.innerText = "Connection: " + pc.connectionState;
        }

    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    ws.onmessage = async e => {
        const msg = JSON.parse(e.data);

        if (msg.type === "role") {
            isInitiator = msg.initiator;
            statusEl.innerText = isInitiator ? "Waiting for peer..." : "Joining call...(waiting initiator)";
            return;
        }

        if (msg.type) {
            const sdp = new RTCSessionDescription(msg);
            await pc.setRemoteDescription(sdp);

            if (sdp.type === "offer") {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify(answer));
            }
        } else if (msg.candidate) {
            await pc.addIceCandidate(msg);
        }
    };

    // –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ Start
    async function start() {
        // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
        await getMediaStream();

        // –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç offer –æ–¥–∏–Ω —Ä–∞–∑
        if (isInitiator) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify(offer));
        }
    }
</script>

</body>
</html>